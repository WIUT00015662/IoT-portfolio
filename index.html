<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.5em;
        }

        .current-value {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .unit {
            font-size: 0.5em;
            color: #888;
        }

        .last-updated {
            font-size: 0.85em;
            color: #888;
            margin-top: 10px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .control-card h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
        }

        .toggle-switch {
            position: relative;
            width: 70px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(36px);
        }

        .fan-status {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .voice-control {
            text-align: center;
        }

        .speak-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .speak-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(102, 126, 234, 0.6);
        }

        .speak-btn:active {
            transform: scale(0.95);
        }

        .speak-btn.listening {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
            }
            50% {
                box-shadow: 0 5px 30px rgba(240, 147, 251, 0.8);
            }
        }

        .voice-transcript {
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 10px;
            min-height: 50px;
            font-style: italic;
            color: #555;
        }

        .status-log {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9em;
        }

        .status-log div {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .status-log div:last-child {
            border-bottom: none;
        }

        .status-success {
            color: #27ae60;
        }

        .status-error {
            color: #e74c3c;
        }

        .status-info {
            color: #3498db;
        }

        .analysis-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .analysis-card h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .analysis-item {
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            text-align: center;
        }

        .analysis-item h3 {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 10px;
        }

        .analysis-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }

        .config-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .config-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .config-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }

        .config-btn:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè† Smart Home Dashboard</h1>
            <p>Real-time monitoring and control</p>
        </header>

        <!-- Configuration Section -->
        <div class="config-section">
            <h2>‚öôÔ∏è Configuration</h2>
            <input type="text" id="supabaseUrl" class="config-input" placeholder="Supabase URL (e.g., https://xxx.supabase.co)">
            <input type="password" id="supabaseKey" class="config-input" placeholder="Supabase Anon Key">
            <input type="password" id="openrouterKey" class="config-input" placeholder="OpenRouter API Key (free at openrouter.ai)">
            <button class="config-btn" onclick="saveConfig()">üíæ Save Configuration</button>
        </div>

        <!-- Current Values Dashboard -->
        <div class="dashboard">
            <div class="card">
                <h2><span class="card-icon">üå°Ô∏è</span> Temperature</h2>
                <div class="current-value" id="currentTemp">--<span class="unit">¬∞C</span></div>
                <div class="last-updated" id="tempUpdated">Loading...</div>
            </div>

            <div class="card">
                <h2><span class="card-icon">üíß</span> Humidity</h2>
                <div class="current-value" id="currentHumidity">--<span class="unit">%</span></div>
                <div class="last-updated" id="humidityUpdated">Loading...</div>
            </div>

            <div class="card">
                <h2><span class="card-icon">üåô</span> Room Brightness</h2>
                <div class="current-value" id="currentRoomBrightness">--</div>
                <div class="last-updated" id="brightnessUpdated">Loading...</div>
            </div>

            <div class="card">
                <h2><span class="card-icon">üí°</span> LED Brightness</h2>
                <div class="current-value" id="currentLedBrightness">--</div>
                <div class="last-updated" id="ledUpdated">Loading...</div>
            </div>
        </div>

        <!-- Data Analysis -->
        <div class="analysis-card">
            <h2>üìä Data Analysis</h2>
            <div class="analysis-grid">
                <div class="analysis-item">
                    <h3>Avg Temperature</h3>
                    <div class="analysis-value" id="avgTemp">--¬∞C</div>
                </div>
                <div class="analysis-item">
                    <h3>Avg Humidity</h3>
                    <div class="analysis-value" id="avgHumidity">--%</div>
                </div>
                <div class="analysis-item">
                    <h3>Peak Room Brightness</h3>
                    <div class="analysis-value" id="maxBrightness">--</div>
                </div>
                <div class="analysis-item">
                    <h3>Energy Efficiency</h3>
                    <div class="analysis-value" id="efficiency">--%</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="chart-container">
            <h2>üìà Temperature & Humidity Trends</h2>
            <canvas id="tempHumidityChart"></canvas>
        </div>

        <div class="chart-container">
            <h2>üí° Brightness Analysis</h2>
            <canvas id="brightnessChart"></canvas>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-card">
                <h2>üåÄ Fan Control</h2>
                <div class="toggle-container">
                    <span class="fan-status" id="fanStatus">OFF</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="fanToggle" onchange="toggleFan()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="status-log" id="fanLog"></div>
            </div>

            <div class="control-card voice-control">
                <h2>üé§ Voice Control</h2>
                <button class="speak-btn" id="speakBtn" onclick="startVoiceCommand()">
                    <span id="micIcon">üé§</span>
                    <span id="btnText">Press to Speak</span>
                </button>
                <div class="voice-transcript" id="transcript">Your command will appear here...</div>
                <div class="status-log" id="voiceLog"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let config = {
            supabaseUrl: '',
            supabaseKey: '',
            openrouterKey: ''
        };

        // Load config from localStorage
        function loadConfig() {
            const saved = localStorage.getItem('iotConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('supabaseUrl').value = config.supabaseUrl;
                document.getElementById('supabaseKey').value = config.supabaseKey;
                document.getElementById('openrouterKey').value = config.openrouterKey || '';
            }
        }

        function saveConfig() {
            let supabaseUrl = document.getElementById('supabaseUrl').value.trim().replace(/\/$/, ''); // Remove trailing slash
            
            // Add https:// if protocol is missing
            if (supabaseUrl && !supabaseUrl.startsWith('http://') && !supabaseUrl.startsWith('https://')) {
                supabaseUrl = 'https://' + supabaseUrl;
            }
            
            config.supabaseUrl = supabaseUrl;
            config.supabaseKey = document.getElementById('supabaseKey').value.trim();
            config.openrouterKey = document.getElementById('openrouterKey').value.trim();
            
            // Validate before saving
            if (!config.supabaseUrl) {
                alert('‚ùå Please enter a Supabase URL');
                return;
            }
            if (!config.supabaseKey) {
                alert('‚ùå Please enter a Supabase API Key');
                return;
            }
            
            localStorage.setItem('iotConfig', JSON.stringify(config));
            console.log('‚úÖ Config saved:', { url: config.supabaseUrl, hasKey: !!config.supabaseKey, hasOpenRouter: !!config.openrouterKey });
            alert('‚úÖ Configuration saved!');
            
            // Reload data with new config
            fetchAllData();
        }

        // Charts
        let tempHumidityChart, brightnessChart;

        // Initialize charts
        function initCharts() {
            const tempHumidityCtx = document.getElementById('tempHumidityChart').getContext('2d');
            tempHumidityChart = new Chart(tempHumidityCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (¬∞C)',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Humidity (%)',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const brightnessCtx = document.getElementById('brightnessChart').getContext('2d');
            brightnessChart = new Chart(brightnessCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Room Brightness',
                        data: [],
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea',
                        borderWidth: 2
                    }, {
                        label: 'LED Brightness',
                        data: [],
                        backgroundColor: 'rgba(241, 196, 15, 0.6)',
                        borderColor: '#f1c40f',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Fetch data from Supabase
        async function fetchSupabase(table, limit = 20, hours = null) {
            if (!config.supabaseUrl || !config.supabaseKey) {
                console.log('‚ö†Ô∏è Configuration not set');
                console.log('Current config:', { url: config.supabaseUrl, hasKey: !!config.supabaseKey });
                return null;
            }

            try {
                let url = `${config.supabaseUrl}/rest/v1/${table}?order=created_at.desc`;
                
                // Add time filter if hours specified (for last X hours)
                if (hours) {
                    const hoursAgo = new Date(Date.now() - hours * 60 * 60 * 1000).toISOString();
                    url += `&created_at=gte.${hoursAgo}`;
                }
                
                url += `&limit=${limit}`;
                
                console.log(`üîÑ Fetching from: ${url}`);
                console.log(`üîë API Key present: ${config.supabaseKey ? 'Yes' : 'No'}, Length: ${config.supabaseKey?.length || 0}`);
                
                const response = await fetch(url, {
                    headers: {
                        'apikey': config.supabaseKey,
                        'Authorization': `Bearer ${config.supabaseKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`‚ùå HTTP ${response.status}: ${errorText}`);
                    return null;
                }
                
                const data = await response.json();
                console.log(`‚úÖ Fetched ${data.length} records from ${table}`);
                return data;
            } catch (error) {
                console.error(`‚ùå Error fetching ${table}:`, error);
                return null;
            }
        }

        // Update current values
        async function updateCurrentValues() {
            const tempHumidity = await fetchSupabase('temp_humidity', 1);
            const brightness = await fetchSupabase('brightness', 1);

            if (tempHumidity && tempHumidity.length > 0) {
                const latest = tempHumidity[0];
                document.getElementById('currentTemp').innerHTML = `${latest.temp.toFixed(1)}<span class="unit">¬∞C</span>`;
                document.getElementById('currentHumidity').innerHTML = `${latest.humidity.toFixed(1)}<span class="unit">%</span>`;
                document.getElementById('tempUpdated').textContent = `Updated: ${new Date(latest.created_at).toLocaleString()}`;
                document.getElementById('humidityUpdated').textContent = `Updated: ${new Date(latest.created_at).toLocaleString()}`;
            }

            if (brightness && brightness.length > 0) {
                const latest = brightness[0];
                console.log('üìä Brightness data received:', latest);
                console.log('Room brightness value:', latest.room_brightness);
                console.log('LED_after value:', latest.LED_after);
                console.log('All keys:', Object.keys(latest));
                
                // Handle case-sensitive column names
                const roomBrightness = latest.room_brightness ?? 0;
                const ledAfter = latest.LED_after ?? latest['LED_after'] ?? 0;
                
                document.getElementById('currentRoomBrightness').textContent = roomBrightness;
                document.getElementById('currentLedBrightness').textContent = ledAfter;
                document.getElementById('brightnessUpdated').textContent = `Updated: ${new Date(latest.created_at).toLocaleString()}`;
                document.getElementById('ledUpdated').textContent = `Updated: ${new Date(latest.created_at).toLocaleString()}`;
            }
        }

        // Update charts
        async function updateCharts() {
            // Fetch last 12 hours of data (limit 1000 to ensure we get enough)
            const tempHumidity = await fetchSupabase('temp_humidity', 1000, 12);
            const brightness = await fetchSupabase('brightness', 1000, 12);

            if (tempHumidity && tempHumidity.length > 0) {
                const reversed = tempHumidity.reverse();
                // Format labels to show date + time for 12-hour view
                tempHumidityChart.data.labels = reversed.map(d => {
                    const date = new Date(d.created_at);
                    return date.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                });
                tempHumidityChart.data.datasets[0].data = reversed.map(d => d.temp);
                tempHumidityChart.data.datasets[1].data = reversed.map(d => d.humidity);
                tempHumidityChart.update();
                console.log(`üìä Temperature chart updated with ${reversed.length} data points`);
            }

            if (brightness && brightness.length > 0) {
                console.log('üìà Brightness data - Total records:', brightness.length);
                console.log('üìà First record:', brightness[0]);
                console.log('üìà Sample room_brightness values:', brightness.slice(0, 5).map(d => d.room_brightness));
                console.log('üìà Sample LED_after values:', brightness.slice(0, 5).map(d => d.LED_after));
                
                const reversed = brightness.reverse();
                brightnessChart.data.labels = reversed.map(d => {
                    const date = new Date(d.created_at);
                    return date.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                });
                brightnessChart.data.datasets[0].data = reversed.map(d => d.room_brightness ?? 0);
                brightnessChart.data.datasets[1].data = reversed.map(d => d.LED_after ?? d['LED_after'] ?? 0);
                brightnessChart.update();
                console.log(`üí° Brightness chart updated with ${reversed.length} data points`);
            } else {
                console.log('‚ö†Ô∏è No brightness data available for chart');
            }
        }

        // Data analysis
        async function performAnalysis() {
            const tempHumidity = await fetchSupabase('temp_humidity', 100);
            const brightness = await fetchSupabase('brightness', 100);

            if (tempHumidity && tempHumidity.length > 0) {
                const avgTemp = tempHumidity.reduce((sum, d) => sum + d.temp, 0) / tempHumidity.length;
                const avgHumidity = tempHumidity.reduce((sum, d) => sum + d.humidity, 0) / tempHumidity.length;
                
                document.getElementById('avgTemp').textContent = `${avgTemp.toFixed(1)}¬∞C`;
                document.getElementById('avgHumidity').textContent = `${avgHumidity.toFixed(1)}%`;
            }

            if (brightness && brightness.length > 0) {
                const maxBrightness = Math.max(...brightness.map(d => d.room_brightness ?? 0));
                document.getElementById('maxBrightness').textContent = maxBrightness;

                // Calculate efficiency: ratio of LED adjustment vs room brightness change
                const avgRoomBrightness = brightness.reduce((sum, d) => sum + (d.room_brightness ?? 0), 0) / brightness.length;
                const avgLEDBrightness = brightness.reduce((sum, d) => sum + (d.LED_after ?? d['LED_after'] ?? 0), 0) / brightness.length;
                const efficiency = avgRoomBrightness > 0 ? ((255 - avgLEDBrightness) / (avgRoomBrightness / 1023) * 100).toFixed(0) : 0;
                document.getElementById('efficiency').textContent = `${efficiency}%`;
            }
        }

        // Fetch all data
        async function fetchAllData() {
            console.log('üîÑ Fetching all data...');
            await updateCurrentValues();
            await updateCharts();
            await performAnalysis();
            await updateFanStatus();
            console.log('‚úÖ All data updated');
        }

        // Fan control
        async function updateFanStatus() {
            const fanData = await fetchSupabase('fan', 1);
            if (fanData && fanData.length > 0) {
                const isOn = fanData[0].fan_state;
                document.getElementById('fanToggle').checked = isOn;
                document.getElementById('fanStatus').textContent = isOn ? 'ON' : 'OFF';
                document.getElementById('fanStatus').style.color = isOn ? '#27ae60' : '#e74c3c';
            }
        }

        async function toggleFan() {
            const isOn = document.getElementById('fanToggle').checked;
            addLog('fanLog', `‚è≥ Setting fan to ${isOn ? 'ON' : 'OFF'}...`, 'info');

            try {
                const response = await fetch(`${config.supabaseUrl}/rest/v1/fan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': config.supabaseKey,
                        'Authorization': `Bearer ${config.supabaseKey}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ fan_state: isOn })
                });

                if (response.ok) {
                    document.getElementById('fanStatus').textContent = isOn ? 'ON' : 'OFF';
                    document.getElementById('fanStatus').style.color = isOn ? '#27ae60' : '#e74c3c';
                    addLog('fanLog', `‚úÖ Fan turned ${isOn ? 'ON' : 'OFF'}`, 'success');
                } else {
                    addLog('fanLog', '‚ùå Failed to update fan status', 'error');
                }
            } catch (error) {
                console.error('Error toggling fan:', error);
                addLog('fanLog', '‚ùå Error: ' + error.message, 'error');
            }
        }

        // Voice control
        let recognition;
        
        function startVoiceCommand() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Speech recognition not supported in this browser. Please use Chrome.');
                return;
            }

            if (!config.openrouterKey) {
                alert('Please configure your OpenRouter API key first! Get a free key at openrouter.ai');
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;

            const btn = document.getElementById('speakBtn');
            btn.classList.add('listening');
            document.getElementById('btnText').textContent = 'Listening...';
            document.getElementById('micIcon').textContent = 'üî¥';
            addLog('voiceLog', 'üé§ Listening for command...', 'info');

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('transcript').textContent = `"${transcript}"`;
                addLog('voiceLog', `üìù You said: "${transcript}"`, 'info');

                btn.classList.remove('listening');
                document.getElementById('btnText').textContent = 'Processing...';
                document.getElementById('micIcon').textContent = '‚è≥';

                await processVoiceCommand(transcript);

                document.getElementById('btnText').textContent = 'Press to Speak';
                document.getElementById('micIcon').textContent = 'üé§';
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                addLog('voiceLog', `‚ùå Error: ${event.error}`, 'error');
                btn.classList.remove('listening');
                document.getElementById('btnText').textContent = 'Press to Speak';
                document.getElementById('micIcon').textContent = 'üé§';
            };

            recognition.start();
        }

        async function processVoiceCommand(transcript) {
            addLog('voiceLog', 'ü§ñ Sending to AI (OpenRouter)...', 'info');

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.openrouterKey}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Smart Home Dashboard'
                    },
                    body: JSON.stringify({
                        model: 'openai/gpt-oss-20b:free',
                        messages: [{
                            role: 'system',
                            content: `You are a smart home command parser. Parse user commands and return ONLY valid JSON. 
                            
Commands can be:
1. Fan control: "turn on fan", "fan off", "switch fan on", "default"
2. LED control: "make it brighter", "dim the lights", "turn off lights", "maximum brightness"

Return JSON in this exact format:
{
  "command_type": "fan" or "led",
  "command": for fan: "on", "off", or "default", for LED: "brighter", "dimmer", "off", "max"
}

Examples:
User: "turn on the fan" -> {"command_type": "fan", "command": "on"}
User: "make it brighter" -> {"command_type": "led", "command": "brighter"}
User: "lights off" -> {"command_type": "led", "command": "off"}
User: "default" -> {"command_type": "fan", "command": "default"}

Return ONLY the JSON object, no additional text.`
                        }, {
                            role: 'user',
                            content: transcript
                        }],
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                const commandText = data.choices[0].message.content.trim();
                
                addLog('voiceLog', `ü§ñ AI response: ${commandText}`, 'info');

                // Parse JSON from response
                let command;
                try {
                    // Remove markdown code blocks if present
                    const jsonText = commandText.replace(/```json\n?|\n?```/g, '');
                    command = JSON.parse(jsonText);
                } catch (e) {
                    addLog('voiceLog', '‚ùå Failed to parse command JSON', 'error');
                    return;
                }

                addLog('voiceLog', `‚úÖ Parsed: ${command.command_type} - ${command.command}`, 'success');

                // Save to database
                await saveCommand(command);

            } catch (error) {
                console.error('Error processing command:', error);
                addLog('voiceLog', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function saveCommand(command) {
            addLog('voiceLog', 'üíæ Saving command to database...', 'info');

            try {
                const response = await fetch(`${config.supabaseUrl}/rest/v1/command`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': config.supabaseKey,
                        'Authorization': `Bearer ${config.supabaseKey}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        command: command.command,
                        command_type: command.command_type,
                        status: 'pending'
                    })
                });

                if (response.ok) {
                    addLog('voiceLog', '‚úÖ Command sent to database! NodeMCU will process it.', 'success');
                } else {
                    addLog('voiceLog', '‚ùå Failed to save command', 'error');
                }
            } catch (error) {
                console.error('Error saving command:', error);
                addLog('voiceLog', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Helper function to add logs
        function addLog(elementId, message, type = 'info') {
            const log = document.getElementById(elementId);
            const entry = document.createElement('div');
        
            entry.className = `status-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        
            // Add to log container
            log.appendChild(entry);
        
            // Auto-scroll to the latest entry
            log.scrollTop = log.scrollHeight;
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Initializing dashboard...');
            loadConfig();
            initCharts();
            
            // Only fetch data if config is set
            if (config.supabaseUrl && config.supabaseKey) {
                fetchAllData();
                // Auto-refresh every 30 seconds
                setInterval(fetchAllData, 30000);
            } else {
                console.log('‚ö†Ô∏è Please configure your Supabase credentials');
            }
        });
</script>
